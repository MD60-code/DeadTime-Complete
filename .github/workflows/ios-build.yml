name: iOS DeadTime Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Create iOS project structure
      run: |
        echo "ðŸŽ Creating DeadTime iOS Project..."
        mkdir -p ios/DeadTime
        
    - name: Create iOS Swift files
      run: |
        # Create AppDelegate.swift
        cat > ios/DeadTime/AppDelegate.swift << 'EOF'
        import UIKit
        import CoreLocation
        
        @main
        class AppDelegate: UIResponder, UIApplicationDelegate {
            var window: UIWindow?
            
            func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
                print("ðŸŽ DeadTime iOS v4.0 Started!")
                
                window = UIWindow(frame: UIScreen.main.bounds)
                window?.rootViewController = ViewController()
                window?.makeKeyAndVisible()
                
                return true
            }
        }
        EOF
        
        # Create ViewController.swift  
        cat > ios/DeadTime/ViewController.swift << 'EOF'
        import UIKit
        import CoreLocation
        
        class ViewController: UIViewController, CLLocationManagerDelegate {
            private let locationManager = CLLocationManager()
            private var statusLabel: UILabel!
            private var earningsLabel: UILabel!
            private var totalEarnings: Double = 0.0
            
            override func viewDidLoad() {
                super.viewDidLoad()
                setupUI()
                setupLocationServices()
                print("ðŸ’° DeadTime iOS - Money Making Engine Loaded!")
            }
            
            private func setupUI() {
                view.backgroundColor = UIColor(red: 0.04, green: 0.04, blue: 0.1, alpha: 1.0)
                
                let titleLabel = UILabel()
                titleLabel.text = "ðŸ’° DeadTime"
                titleLabel.font = UIFont.boldSystemFont(ofSize: 32)
                titleLabel.textColor = UIColor(red: 0.0, green: 1.0, blue: 0.53, alpha: 1.0)
                titleLabel.textAlignment = .center
                titleLabel.translatesAutoresizingMaskIntoConstraints = false
                view.addSubview(titleLabel)
                
                statusLabel = UILabel()
                statusLabel.text = "ðŸ” Detecting opportunities..."
                statusLabel.font = UIFont.systemFont(ofSize: 18)
                statusLabel.textColor = .white
                statusLabel.textAlignment = .center
                statusLabel.numberOfLines = 0
                statusLabel.layer.cornerRadius = 8
                statusLabel.backgroundColor = UIColor(red: 0.1, green: 0.1, blue: 0.2, alpha: 1.0)
                statusLabel.translatesAutoresizingMaskIntoConstraints = false
                view.addSubview(statusLabel)
                
                earningsLabel = UILabel()
                earningsLabel.text = "Total Earned: â‚¬0.00"
                earningsLabel.font = UIFont.boldSystemFont(ofSize: 24)
                earningsLabel.textColor = UIColor(red: 0.0, green: 1.0, blue: 0.53, alpha: 1.0)
                earningsLabel.textAlignment = .center
                earningsLabel.translatesAutoresizingMaskIntoConstraints = false
                view.addSubview(earningsLabel)
                
                NSLayoutConstraint.activate([
                    titleLabel.centerXAnchor.constraint(equalTo: view.centerXAnchor),
                    titleLabel.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor, constant: 50),
                    
                    statusLabel.centerXAnchor.constraint(equalTo: view.centerXAnchor),
                    statusLabel.centerYAnchor.constraint(equalTo: view.centerYAnchor),
                    statusLabel.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: 20),
                    statusLabel.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -20),
                    statusLabel.heightAnchor.constraint(equalToConstant: 100),
                    
                    earningsLabel.centerXAnchor.constraint(equalTo: view.centerXAnchor),
                    earningsLabel.bottomAnchor.constraint(equalTo: view.safeAreaLayoutGuide.bottomAnchor, constant: -50)
                ])
            }
            
            private func setupLocationServices() {
                locationManager.delegate = self
                locationManager.requestWhenInUseAuthorization()
                locationManager.startUpdatingLocation()
            }
            
            func locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation]) {
                guard let location = locations.last else { return }
                
                // Simulate money-making opportunity detection
                let opportunity = detectOpportunity(at: location)
                updateUI(with: opportunity)
            }
            
            private func detectOpportunity(at location: CLLocation) -> (amount: Double, description: String) {
                let opportunities = [
                    (12.50, "ðŸ¥ Hospital waiting area detected"),
                    (8.75, "ðŸšŒ Bus stop opportunity found"),
                    (15.25, "ðŸ“‹ Queue detected - Premium rate"),
                    (6.50, "â˜• Cafe waiting time"),
                    (20.00, "âœˆï¸ Airport terminal - High value")
                ]
                
                return opportunities.randomElement() ?? (5.00, "ðŸŽ¯ General opportunity")
            }
            
            private func updateUI(with opportunity: (amount: Double, description: String)) {
                DispatchQueue.main.async {
                    self.totalEarnings += opportunity.amount
                    self.statusLabel.text = "ðŸ’° \(opportunity.description)\n+â‚¬\(String(format: "%.2f", opportunity.amount))"
                    self.earningsLabel.text = "Total Earned: â‚¬\(String(format: "%.2f", self.totalEarnings))"
                    
                    self.statusLabel.backgroundColor = UIColor(red: 0.0, green: 0.6, blue: 0.3, alpha: 1.0)
                    
                    // Reset after 3 seconds
                    DispatchQueue.main.asyncAfter(deadline: .now() + 3) {
                        self.statusLabel.text = "ðŸ” Scanning for new opportunities..."
                        self.statusLabel.backgroundColor = UIColor(red: 0.1, green: 0.1, blue: 0.2, alpha: 1.0)
                    }
                }
            }
        }
        EOF
        
    - name: Create Info.plist
      run: |
        cat > ios/DeadTime/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>en</string>
            <key>CFBundleDisplayName</key>
            <string>DeadTime</string>
            <key>CFBundleExecutable</key>
            <string>DeadTime</string>
            <key>CFBundleIdentifier</key>
            <string>com.deadtime.app</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>DeadTime</string>
            <key>CFBundleShortVersionString</key>
            <string>4.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSRequiresIPhoneOS</key>
            <true/>
            <key>NSLocationWhenInUseUsageDescription</key>
            <string>DeadTime needs location access to detect waiting opportunities and maximize your earnings.</string>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>armv7</string>
                <string>location-services</string>
            </array>
            <key>UISupportedInterfaceOrientations</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
            </array>
        </dict>
        </plist>
        EOF
        
    - name: Create Xcode project
      run: |
        cat > ios/DeadTime.xcodeproj/project.pbxproj << 'EOF'
        // !$*UTF8*$!
        {
            archiveVersion = 1;
            classes = {
            };
            objectVersion = 56;
            objects = {
                1A2B3C4D5E6F7890ABCD1234 /* AppDelegate.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = AppDelegate.swift; sourceTree = "<group>"; };
                1A2B3C4D5E6F7890ABCD1235 /* ViewController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = ViewController.swift; sourceTree = "<group>"; };
                1A2B3C4D5E6F7890ABCD1236 /* Info.plist */ = {isa = PBXFileReference; lastKnownFileType = text.plist.xml; path = Info.plist; sourceTree = "<group>"; };
                1A2B3C4D5E6F7890ABCD1237 /* DeadTime.app */ = {isa = PBXFileReference; explicitFileType = wrapper.application; includeInIndex = 0; path = DeadTime.app; sourceTree = BUILT_PRODUCTS_DIR; };
                
                1A2B3C4D5E6F7890ABCD1238 /* DeadTime */ = {
                    isa = PBXGroup;
                    children = (
                        1A2B3C4D5E6F7890ABCD1234 /* AppDelegate.swift */,
                        1A2B3C4D5E6F7890ABCD1235 /* ViewController.swift */,
                        1A2B3C4D5E6F7890ABCD1236 /* Info.plist */,
                    );
                    path = DeadTime;
                    sourceTree = "<group>";
                };
                
                1A2B3C4D5E6F7890ABCD1239 /* Products */ = {
                    isa = PBXGroup;
                    children = (
                        1A2B3C4D5E6F7890ABCD1237 /* DeadTime.app */,
                    );
                    name = Products;
                    sourceTree = "<group>";
                };
                
                1A2B3C4D5E6F7890ABCD123A = {
                    isa = PBXProject;
                    attributes = {
                        LastSwiftUpdateCheck = 1500;
                        LastUpgradeCheck = 1500;
                    };
                    buildConfigurationList = 1A2B3C4D5E6F7890ABCD123C;
                    compatibilityVersion = "Xcode 14.0";
                    developmentRegion = en;
                    hasScannedForEncodings = 0;
                    knownRegions = (
                        en,
                        Base,
                    );
                    mainGroup = 1A2B3C4D5E6F7890ABCD123D;
                    productRefGroup = 1A2B3C4D5E6F7890ABCD1239;
                    projectDirPath = "";
                    projectRoot = "";
                    targets = (
                        1A2B3C4D5E6F7890ABCD123B /* DeadTime */,
                    );
                };
            };
            rootObject = 1A2B3C4D5E6F7890ABCD123A;
        }
        EOF
        
    - name: Build iOS app
      run: |
        cd ios
        xcodebuild -project DeadTime.xcodeproj \
          -scheme DeadTime \
          -configuration Debug \
          -destination generic/platform=iOS \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          build
          
    - name: Create IPA (if successful)
      run: |
        echo "ðŸŽ‰ iOS DeadTime Build Completed!"
        echo "ðŸ“± App ready for deployment"
        ls -la ios/build/
        
    - name: Upload iOS app artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeadTime-iOS-App
        path: ios/build/Debug-iphoneos/DeadTime.app
